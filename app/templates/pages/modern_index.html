{% extends "layouts/dashboard_layout.html" %}

{% block title %}Kronos 智能投资平台 - 首页{% endblock %}

{% block page_title %}智能股票预测{% endblock %}
{% block page_subtitle %}基于先进AI模型的智能投资决策平台{% endblock %}

{% block page_actions %}
<button class="btn btn-primary btn-lg" onclick="scrollToPredictionForm()">
    <i class="fas fa-magic"></i>
    开始智能预测
</button>
<button class="btn btn-secondary" onclick="scrollToMarketOverview()">
    <i class="fas fa-chart-area"></i>
    市场概览
</button>
<button class="btn btn-success" onclick="scrollToHotStocks()">
    <i class="fas fa-fire"></i>
    热门股票
</button>
{% endblock %}

{% block content %}
<!-- Quick Stats Banner -->
<div class="stats-banner">
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">256</div>
            <div class="stat-label">今日预测</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-bullseye"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">87.3%</div>
            <div class="stat-label">预测准确率</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">12,489</div>
            <div class="stat-label">活跃用户</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon danger">
            <i class="fas fa-coins"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">¥2.8M</div>
            <div class="stat-label">累计收益</div>
        </div>
    </div>
</div>

<!-- Main Prediction Area -->
<div class="prediction-container" id="prediction-area">
    <div class="prediction-header">
        <h2>
            <i class="fas fa-brain text-primary"></i>
            AI智能预测 <span class="badge badge-demo">演示版本</span>
        </h2>
        <p>选择股票代码，获取基于多模型分析的预测结果 (当前使用Mock数据演示)</p>
    </div>
    
    <div class="prediction-form-card">
        <form hx-post="/components/mock-prediction-result"
              hx-target="#prediction-results"
              hx-indicator=".prediction-btn">
            <div class="form-row">
                <div class="form-group">
                    <label for="stock_symbol">股票代码</label>
                    <div class="input-group">
                        <input type="text" 
                               id="stock_symbol" 
                               name="stock_symbol" 
                               class="form-control" 
                               placeholder="输入股票代码，如 000001"
                               hx-get="/api/stocks/search"
                               hx-trigger="input changed delay:500ms, search"
                               hx-target="#suggestions"
                               hx-include="[name='stock_symbol']"
                               autocomplete="off"
                               required>
                        <button type="button" class="btn-input-addon" onclick="showHotStocks()">
                            <i class="fas fa-fire"></i>
                        </button>
                    </div>
                    <div id="suggestions" class="suggestions-dropdown" style="display: none;"
                         hx-target="this"
                         hx-swap="innerHTML">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="model_type">预测模型</label>
                    <select id="model_type" name="model_type" class="form-control" required>
                        <option value="">选择模型</option>
                        <option value="kronos-base">Kronos Base (平衡型)</option>
                        <option value="kronos-mini">Kronos Mini (快速型)</option>
                        <option value="kronos-small">Kronos Small (精准型)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="prediction_days">预测天数</label>
                    <select id="prediction_days" name="prediction_days" class="form-control">
                        <option value="1">1天</option>
                        <option value="3">3天</option>
                        <option value="5" selected>5天</option>
                        <option value="10">10天</option>
                        <option value="30">30天</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-lg prediction-btn">
                        <i class="fas fa-magic"></i>
                        <span>开始预测</span>
                        <div id="prediction-loading" class="htmx-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Prediction Results -->
<div id="prediction-results" class="prediction-results">
    <!-- Results will be loaded here via HTMX -->
</div>

<!-- Recent Predictions -->
<div class="recent-predictions">
    <div class="section-header">
        <h3>
            <i class="fas fa-history text-secondary"></i>
            最近预测
        </h3>
        <a href="/history" class="btn btn-secondary btn-sm">查看全部</a>
    </div>
    
    <div class="predictions-grid" id="recent-predictions-grid"
         hx-get="/components/recent-predictions"
         hx-trigger="load">
        <div class="loading-placeholder">
            <div class="skeleton prediction-card"></div>
            <div class="skeleton prediction-card"></div>
            <div class="skeleton prediction-card"></div>
        </div>
    </div>
</div>

<!-- Popular Stocks -->
<div class="popular-stocks">
    <div class="section-header">
        <h3>
            <i class="fas fa-fire text-warning"></i>
            热门股票
        </h3>
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all" onclick="filterStocks('all')">全部</button>
            <button class="filter-tab" data-filter="tech" onclick="filterStocks('tech')">科技</button>
            <button class="filter-tab" data-filter="finance" onclick="filterStocks('finance')">金融</button>
            <button class="filter-tab" data-filter="energy" onclick="filterStocks('energy')">能源</button>
        </div>
    </div>
    
    <div class="stocks-grid" id="popular-stocks-grid"
         hx-get="/components/hot-stocks"
         hx-trigger="load">
        <div class="loading-placeholder">
            <div class="skeleton stock-card"></div>
            <div class="skeleton stock-card"></div>
            <div class="skeleton stock-card"></div>
            <div class="skeleton stock-card"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block content_sidebar %}
<!-- Usage Stats Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-chart-pie text-primary"></i>
            今日使用统计
        </h3>
    </div>
    <div class="card-content">
        <div class="usage-stats">
            <div class="usage-item">
                <div class="usage-label">预测次数</div>
                <div class="usage-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 60%"></div>
                    </div>
                    <span class="usage-count">6/10</span>
                </div>
            </div>
            <div class="usage-item">
                <div class="usage-label">API调用</div>
                <div class="usage-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 30%"></div>
                    </div>
                    <span class="usage-count">30/100</span>
                </div>
            </div>
            <div class="upgrade-prompt">
                <p class="text-muted">升级到专业版，享受更多预测次数</p>
                <button class="btn btn-warning btn-sm">
                    <i class="fas fa-crown"></i>
                    立即升级
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Market Overview Card -->
<div class="card" id="market-overview-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-chart-line text-success"></i>
            市场概览
        </h3>
    </div>
    <div class="card-content">
        <div class="market-stats" id="market-stats"
             hx-get="/components/market-overview"
             hx-trigger="load">
            <div class="loading-placeholder">
                <div class="skeleton stat-item" style="height: 20px; margin-bottom: 10px;"></div>
                <div class="skeleton stat-item" style="height: 20px; margin-bottom: 10px;"></div>
                <div class="skeleton stat-item" style="height: 20px; margin-bottom: 10px;"></div>
            </div>
        </div>
        <div class="market-sentiment">
            <div class="sentiment-header">市场情绪</div>
            <div class="sentiment-bar">
                <div class="sentiment-fill bullish" style="width: 65%"></div>
            </div>
            <div class="sentiment-labels">
                <span class="text-danger">看跌</span>
                <span class="text-success">看涨 65%</span>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-brain text-primary"></i>
            AI市场洞察
        </h3>
    </div>
    <div class="card-content">
        <div class="ai-insights">
            <div class="insight-item">
                <div class="insight-icon">
                    <i class="fas fa-trending-up text-success"></i>
                </div>
                <div class="insight-content">
                    <div class="insight-title">新能源板块机会</div>
                    <div class="insight-desc">基于技术面分析，新能源板块有望在未来3-5天内上涨</div>
                    <div class="insight-confidence">置信度: 85%</div>
                </div>
            </div>
            
            <div class="insight-item">
                <div class="insight-icon">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                </div>
                <div class="insight-content">
                    <div class="insight-title">消费股调整</div>
                    <div class="insight-desc">消费类股票可能面临短期调整，建议谨慎操作</div>
                    <div class="insight-confidence">置信度: 72%</div>
                </div>
            </div>
            
            <div class="insight-item">
                <div class="insight-icon">
                    <i class="fas fa-chart-bar text-primary"></i>
                </div>
                <div class="insight-content">
                    <div class="insight-title">科技股震荡</div>
                    <div class="insight-desc">科技股整体处于震荡整理阶段，等待方向突破</div>
                    <div class="insight-confidence">置信度: 78%</div>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary btn-sm" style="width: 100%; margin-top: 1rem;">
            <i class="fas fa-plus"></i>
            查看更多洞察
        </button>
    </div>
</div>

<!-- Quick Actions Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-bolt text-warning"></i>
            快速操作
        </h3>
    </div>
    <div class="card-content">
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="showStockSearch()">
                <i class="fas fa-search"></i>
                <span>搜索股票</span>
            </button>
            <button class="quick-action-btn" onclick="showWatchlist()">
                <i class="fas fa-star"></i>
                <span>我的关注</span>
            </button>
            <button class="quick-action-btn" onclick="showAlerts()">
                <i class="fas fa-bell"></i>
                <span>价格预警</span>
            </button>
            <button class="quick-action-btn" onclick="showHistory()">
                <i class="fas fa-history"></i>
                <span>预测历史</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 硬编码的股票数据
const stocksData = [
    { symbol: '000001', name: '平安银行', price: 12.75, change: 2.34, industry: '银行业' },
    { symbol: '000002', name: '万科A', price: 18.90, change: -1.56, industry: '房地产' },
    { symbol: '600519', name: '贵州茅台', price: 1695.50, change: 0.89, industry: '食品饮料' },
    { symbol: '600036', name: '招商银行', price: 35.20, change: 1.78, industry: '银行业' },
    { symbol: '000858', name: '五粮液', price: 128.45, change: -0.67, industry: '食品饮料' },
    { symbol: '600031', name: '三一重工', price: 18.76, change: 3.45, industry: '机械设备' },
    { symbol: '000063', name: '中兴通讯', price: 32.18, change: -2.11, industry: '通信设备' },
    { symbol: '002415', name: '海康威视', price: 45.67, change: 1.23, industry: '电子设备' },
    { symbol: '000166', name: '申万宏源', price: 4.56, change: 0.78, industry: '证券业' },
    { symbol: '600887', name: '伊利股份', price: 34.12, change: -0.45, industry: '食品饮料' }
];

// 股票搜索功能
// 我们现在使用HTMX来处理股票搜索，所以移除这个函数

function selectStock(symbol, name) {
    document.getElementById('stock_symbol').value = symbol;
    document.getElementById('suggestions').style.display = 'none';
    
    // 显示选中动画
    const input = document.getElementById('stock_symbol');
    input.style.borderColor = '#28a745';
    setTimeout(() => {
        input.style.borderColor = '';
    }, 1000);
    
    showToast(`已选择 ${symbol} ${name}`, 'success');
}

function showHotStocks() {
    const hotStocks = stocksData.slice(0, 6);
    let html = '';
    
    hotStocks.forEach(stock => {
        const changeClass = stock.change > 0 ? 'text-success' : 'text-danger';
        const changeSign = stock.change > 0 ? '+' : '';
        html += `
            <div class="suggestion-item" onclick="selectStock('${stock.symbol}', '${stock.name}')">
                <div class="stock-basic">
                    <span class="stock-code">${stock.symbol}</span>
                    <span class="stock-name">${stock.name}</span>
                    <small class="text-muted">${stock.industry}</small>
                </div>
                <div class="stock-price">
                    <span class="price">¥${stock.price}</span>
                    <span class="change ${changeClass}">
                        ${changeSign}${stock.change.toFixed(2)}%
                    </span>
                </div>
            </div>
        `;
    });
    
    const suggestions = document.getElementById('suggestions');
    suggestions.innerHTML = `<div style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">🔥 热门股票</div>` + html;
    suggestions.style.display = 'block';
}

// 生成预测功能
function generatePrediction(event) {
    event.preventDefault();
    
    const form = event.target;
    const stockSymbol = form.stock_symbol.value;
    const modelType = form.model_type.value;
    const predictionDays = parseInt(form.prediction_days.value);
    
    if (!stockSymbol || !modelType || !predictionDays) {
        showToast('请填写完整的预测参数', 'error');
        return;
    }
    
    // 查找股票信息
    const stock = stocksData.find(s => s.symbol === stockSymbol);
    if (!stock) {
        showToast('股票代码不存在，请重新选择', 'error');
        return;
    }
    
    // 显示加载状态
    const resultsContainer = document.getElementById('prediction-results');
    resultsContainer.innerHTML = `
        <div class="prediction-loading">
            <div class="loading-spinner">
                <i class="fas fa-brain fa-spin"></i>
            </div>
            <h4>AI正在分析中...</h4>
            <p>正在使用 ${modelType} 模型分析 ${stock.name} (${stockSymbol})</p>
            <div class="loading-progress">
                <div class="progress-bar" id="loadingProgress"></div>
            </div>
        </div>
    `;
    
    // 模拟加载进度
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        document.getElementById('loadingProgress').style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            setTimeout(() => showPredictionResult(stock, modelType, predictionDays), 500);
        }
    }, 200);
    
    // 滚动到结果区域
    resultsContainer.scrollIntoView({ behavior: 'smooth' });
}

function showPredictionResult(stock, modelType, days) {
    // 生成模拟预测结果
    const currentPrice = stock.price;
    const volatility = getModelVolatility(modelType);
    const changeFactor = (Math.random() - 0.5) * 2 * volatility;
    const predictedPrice = currentPrice * (1 + changeFactor);
    const confidence = getModelConfidence(modelType, days);
    const changePercent = ((predictedPrice - currentPrice) / currentPrice) * 100;
    
    const predictionId = 'pred_' + Date.now();
    const isBullish = predictedPrice > currentPrice;
    
    const resultHtml = `
        <div class="prediction-result-card" id="${predictionId}">
            <div class="result-header">
                <div class="stock-info">
                    <h3 class="stock-name">${stock.name}</h3>
                    <span class="stock-code">${stock.symbol}</span>
                    <span class="model-badge badge-${modelType.replace('-', '')}">${modelType}</span>
                </div>
                <div class="prediction-meta">
                    <span class="prediction-time">刚刚生成</span>
                    <span class="prediction-expires">${days}天预测</span>
                </div>
            </div>
            
            <div class="result-content">
                <!-- 价格对比 -->
                <div class="price-comparison">
                    <div class="price-item current">
                        <label>当前价格</label>
                        <span class="price-value">¥${currentPrice.toFixed(2)}</span>
                    </div>
                    <div class="price-arrow">
                        <i class="fas fa-arrow-${isBullish ? 'up text-success' : 'down text-danger'}"></i>
                    </div>
                    <div class="price-item predicted">
                        <label>预测价格</label>
                        <span class="price-value ${isBullish ? 'text-success' : 'text-danger'}">
                            ¥${predictedPrice.toFixed(2)}
                        </span>
                    </div>
                </div>
                
                <!-- 预测指标 -->
                <div class="prediction-metrics">
                    <div class="metric-item">
                        <label>预测涨跌</label>
                        <span class="metric-value ${isBullish ? 'text-success' : 'text-danger'}">
                            ${changePercent > 0 ? '+' : ''}${changePercent.toFixed(2)}%
                        </span>
                    </div>
                    <div class="metric-item">
                        <label>置信度</label>
                        <span class="metric-value">${confidence.toFixed(1)}%</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence}%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 预测分析 -->
                <div class="prediction-analysis">
                    <h6>分析要点</h6>
                    <ul class="analysis-points">
                        ${generateAnalysisPoints(stock, modelType, isBullish)}
                    </ul>
                </div>
                
                <!-- 风险提示 -->
                <div class="risk-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <small>预测仅供参考，投资有风险，决策需谨慎</small>
                </div>
            </div>
            
            <div class="result-actions">
                <button class="btn btn-outline-primary btn-sm" onclick="sharePrediction('${predictionId}')">
                    <i class="fas fa-share"></i> 分享
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="addToWatchlist('${stock.symbol}')">
                    <i class="fas fa-star"></i> 关注
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="showChart('${predictionId}')">
                    <i class="fas fa-chart-line"></i> 图表
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('prediction-results').innerHTML = resultHtml;
    
    // 播放成功音效
    showToast('预测生成成功！', 'success');
    
    // 保存到历史记录
    savePredictionToHistory({
        id: predictionId,
        stock: stock,
        modelType: modelType,
        days: days,
        currentPrice: currentPrice,
        predictedPrice: predictedPrice,
        confidence: confidence,
        timestamp: new Date()
    });
}

function getModelVolatility(modelType) {
    const volatilities = {
        'kronos-base': 0.15,
        'kronos-mini': 0.08,
        'kronos-small': 0.12
    };
    return volatilities[modelType] || 0.10;
}

function getModelConfidence(modelType, days) {
    const baseConfidence = {
        'kronos-base': 82,
        'kronos-mini': 75,
        'kronos-small': 88
    };
    
    const base = baseConfidence[modelType] || 75;
    const daysPenalty = Math.min(days * 1.5, 15); // 长期预测置信度降低
    const randomFactor = (Math.random() - 0.5) * 10;
    
    return Math.max(60, Math.min(95, base - daysPenalty + randomFactor));
}

function generateAnalysisPoints(stock, modelType, isBullish) {
    const points = [
        `基于${stock.industry}行业分析，该股票具有${isBullish ? '上涨' : '下跌'}潜力`,
        `技术指标显示${isBullish ? '买入' : '卖出'}信号较为明显`,
        `市场情绪对该股票呈${isBullish ? '乐观' : '谨慎'}态度`,
        `资金流向数据支持当前${isBullish ? '看涨' : '看跌'}判断`
    ];
    
    return points.slice(0, 3).map(point => `<li>${point}</li>`).join('');
}

// 其他功能函数
function sharePrediction(predictionId) {
    if (navigator.share) {
        navigator.share({
            title: 'Kronos 预测结果',
            text: '查看我的股票预测结果',
            url: window.location.href + '#' + predictionId
        });
    } else {
        const url = window.location.href + '#' + predictionId;
        navigator.clipboard.writeText(url).then(() => {
            showToast('预测链接已复制到剪贴板', 'success');
        });
    }
}

function addToWatchlist(symbol) {
    const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
    if (!watchlist.includes(symbol)) {
        watchlist.push(symbol);
        localStorage.setItem('watchlist', JSON.stringify(watchlist));
        showToast(`已将 ${symbol} 添加到关注列表`, 'success');
    } else {
        showToast(`${symbol} 已在关注列表中`, 'info');
    }
}

function showChart(predictionId) {
    showToast('图表功能开发中，敬请期待...', 'info');
}

function savePredictionToHistory(prediction) {
    const history = JSON.parse(localStorage.getItem('predictionHistory') || '[]');
    history.unshift(prediction);
    if (history.length > 50) history.pop(); // 保留最近50条
    localStorage.setItem('predictionHistory', JSON.stringify(history));
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const iconMap = {
        success: 'check-circle',
        error: 'times-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    
    toast.className = `alert alert-${type} toast-message`;
    toast.innerHTML = `
        <i class="fas fa-${iconMap[type]}"></i>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function scrollToPredictionForm() {
    document.getElementById('prediction-area').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function scrollToMarketOverview() {
    document.getElementById('market-overview-card').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function scrollToHotStocks() {
    document.querySelector('.popular-stocks').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function selectStock(symbol, name) {
    document.getElementById('stock_symbol').value = symbol;
    document.getElementById('suggestions').style.display = 'none';
    
    // 显示选中动画
    const input = document.getElementById('stock_symbol');
    input.style.borderColor = '#28a745';
    setTimeout(() => {
        input.style.borderColor = '';
    }, 1000);
    
    showToast(`已选择 ${symbol} ${name}`, 'success');
}

function quickPredict(symbol) {
    document.getElementById('stock_symbol').value = symbol;
    document.getElementById('prediction-area').scrollIntoView({ behavior: 'smooth' });
    showToast(`已为 ${symbol} 预填写预测表单`, 'success');
}

function showChartPlaceholder(predictionId) {
    const button = event.target;
    const loading = document.getElementById(`chart-loading-${predictionId}`);
    
    // 显示加载状态
    loading.classList.remove('d-none');
    button.disabled = true;
    
    // 模拟加载时间
    setTimeout(() => {
        loading.classList.add('d-none');
        button.disabled = false;
        
        // 显示图表
        const chartContainer = document.getElementById(`chart-${predictionId}`);
        chartContainer.innerHTML = `
            <div class="chart-content">
                <div class="chart-placeholder-content">
                    <i class="fas fa-chart-line"></i>
                    <p>图表功能演示</p>
                    <small class="text-muted">在完整版本中将显示详细的K线图</small>
                </div>
            </div>
        `;
    }, 1500);
}

function sharePrediction(predictionId) {
    if (navigator.share) {
        navigator.share({
            title: 'Kronos 预测结果',
            text: '查看我的股票预测结果',
            url: window.location.href + '#' + predictionId
        });
    } else {
        const url = window.location.href + '#' + predictionId;
        navigator.clipboard.writeText(url).then(() => {
            showToast('预测链接已复制到剪贴板', 'success');
        });
    }
}

function downloadReport(predictionId) {
    showToast('报告下载功能开发中，敬请期待...', 'info');
}

function addToWatchlist(symbol) {
    const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
    if (!watchlist.includes(symbol)) {
        watchlist.push(symbol);
        localStorage.setItem('watchlist', JSON.stringify(watchlist));
        showToast(`已将 ${symbol} 添加到关注列表`, 'success');
    } else {
        showToast(`${symbol} 已在关注列表中`, 'info');
    }
}

// 点击外部关闭搜索建议
document.addEventListener('click', function(e) {
    const suggestions = document.getElementById('suggestions');
    const stockInput = document.getElementById('stock_symbol');
    
    if (!suggestions.contains(e.target) && e.target !== stockInput) {
        suggestions.style.display = 'none';
    }
});

// 页面加载时的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 加载最近预测
    loadRecentPredictions();
    
    // 加载热门股票
    loadPopularStocks('all');
    
    // 加载市场概览
    loadMarketOverview();
    
    // 模拟实时数据更新
    setInterval(updateStats, 30000);
    
    // 显示欢迎提示
    setTimeout(() => {
        showToast('欢迎使用 Kronos 智能投资平台！', 'info');
    }, 1000);
});

function loadRecentPredictions() {
    const container = document.getElementById('recent-predictions-grid');
    const recentPredictions = [
        {
            id: 'pred_001',
            stock: { symbol: '600519', name: '贵州茅台' },
            modelType: 'kronos-base',
            days: 5,
            currentPrice: 1695.50,
            predictedPrice: 1742.30,
            confidence: 85.2,
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
            status: 'bullish'
        },
        {
            id: 'pred_002',
            stock: { symbol: '000001', name: '平安银行' },
            modelType: 'kronos-mini',
            days: 3,
            currentPrice: 12.75,
            predictedPrice: 13.45,
            confidence: 78.9,
            timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
            status: 'bullish'
        },
        {
            id: 'pred_003',
            stock: { symbol: '000002', name: '万科A' },
            modelType: 'kronos-small',
            days: 10,
            currentPrice: 18.90,
            predictedPrice: 17.85,
            confidence: 82.4,
            timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 day ago
            status: 'bearish'
        }
    ];
    
    let html = '';
    recentPredictions.forEach(pred => {
        const changePercent = ((pred.predictedPrice - pred.currentPrice) / pred.currentPrice) * 100;
        const changeClass = changePercent > 0 ? 'text-success' : 'text-danger';
        const changeIcon = changePercent > 0 ? 'arrow-up' : 'arrow-down';
        const timeDiff = getTimeDifference(pred.timestamp);
        
        html += `
            <div class="prediction-card recent-prediction" onclick="viewPredictionDetail('${pred.id}')">
                <div class="prediction-header">
                    <div class="stock-info">
                        <span class="stock-code">${pred.stock.symbol}</span>
                        <span class="stock-name">${pred.stock.name}</span>
                    </div>
                    <span class="model-badge badge-${pred.modelType.replace('-', '')}">${pred.modelType}</span>
                </div>
                <div class="prediction-body">
                    <div class="price-info">
                        <div class="current-price">
                            <label>当前</label>
                            <span>¥${pred.currentPrice.toFixed(2)}</span>
                        </div>
                        <div class="predicted-price">
                            <label>预测</label>
                            <span class="${changeClass}">¥${pred.predictedPrice.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="prediction-change">
                        <i class="fas fa-${changeIcon} ${changeClass}"></i>
                        <span class="${changeClass}">${changePercent > 0 ? '+' : ''}${changePercent.toFixed(2)}%</span>
                    </div>
                </div>
                <div class="prediction-footer">
                    <span class="confidence">置信度: ${pred.confidence.toFixed(1)}%</span>
                    <span class="time-ago">${timeDiff}</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadPopularStocks(filter = 'all') {
    const container = document.getElementById('popular-stocks-grid');
    const allStocks = [
        { symbol: '600519', name: '贵州茅台', price: 1695.50, change: 2.8, volume: '12.5万手', industry: 'finance' },
        { symbol: '000858', name: '五粮液', price: 128.45, change: -0.67, volume: '8.9万手', industry: 'finance' },
        { symbol: '000063', name: '中兴通讯', price: 32.18, change: -2.11, volume: '45.2万手', industry: 'tech' },
        { symbol: '002415', name: '海康威视', price: 45.67, change: 1.23, volume: '23.1万手', industry: 'tech' },
        { symbol: '600036', name: '招商银行', price: 35.20, change: 1.78, volume: '18.7万手', industry: 'finance' },
        { symbol: '600887', name: '伊利股份', price: 34.12, change: -0.45, volume: '15.3万手', industry: 'finance' },
        { symbol: '601318', name: '中国平安', price: 56.78, change: 0.89, volume: '28.4万手', industry: 'finance' },
        { symbol: '000002', name: '万科A', price: 18.90, change: -1.56, volume: '67.8万手', industry: 'finance' }
    ];
    
    const filteredStocks = filter === 'all' ? allStocks : allStocks.filter(stock => stock.industry === filter);
    
    let html = '';
    filteredStocks.slice(0, 8).forEach(stock => {
        const changeClass = stock.change > 0 ? 'text-success' : 'text-danger';
        const changeSign = stock.change > 0 ? '+' : '';
        
        html += `
            <div class="stock-card" onclick="selectStock('${stock.symbol}', '${stock.name}')">
                <div class="stock-header">
                    <div class="stock-basic">
                        <span class="stock-code">${stock.symbol}</span>
                        <span class="stock-name">${stock.name}</span>
                    </div>
                    <div class="stock-price">
                        <span class="price">¥${stock.price}</span>
                        <span class="change ${changeClass}">
                            ${changeSign}${stock.change.toFixed(2)}%
                        </span>
                    </div>
                </div>
                <div class="stock-volume">
                    <i class="fas fa-chart-bar"></i>
                    <span>成交量: ${stock.volume}</span>
                </div>
                <div class="stock-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); addToWatchlist('${stock.symbol}')">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); quickPredict('${stock.symbol}')">
                        <i class="fas fa-zap"></i> 快速预测
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadMarketOverview() {
    const container = document.getElementById('market-stats');
    const marketData = [
        { label: '上证指数', value: '3,247.32', change: 1.2, positive: true },
        { label: '深证成指', value: '10,892.45', change: -0.8, positive: false },
        { label: '创业板指', value: '2,156.78', change: 0.5, positive: true },
        { label: '沪深300', value: '4,123.56', change: 0.9, positive: true }
    ];
    
    let html = '';
    marketData.forEach(item => {
        const changeClass = item.positive ? 'text-success' : 'text-danger';
        const changeSign = item.positive ? '+' : '';
        
        html += `
            <div class="stat-item">
                <span class="stat-label">${item.label}</span>
                <span class="stat-value ${changeClass}">${item.value} (${changeSign}${item.change.toFixed(1)}%)</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filterStocks(filter) {
    // 更新激活状态
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
    
    // 重新加载股票数据
    loadPopularStocks(filter);
    
    showToast(`已切换到${getFilterName(filter)}股票`, 'info');
}

function getFilterName(filter) {
    const names = {
        'all': '全部',
        'tech': '科技',
        'finance': '金融',
        'energy': '能源'
    };
    return names[filter] || '全部';
}

function getTimeDifference(timestamp) {
    const now = new Date();
    const diff = Math.floor((now - timestamp) / (1000 * 60)); // minutes
    
    if (diff < 60) {
        return `${diff}分钟前`;
    } else if (diff < 1440) {
        return `${Math.floor(diff / 60)}小时前`;
    } else {
        return `${Math.floor(diff / 1440)}天前`;
    }
}

function viewPredictionDetail(predictionId) {
    showToast('预测详情功能开发中...', 'info');
}

function updateStats() {
    // 模拟统计数据更新
    const statValues = document.querySelectorAll('.stat-value');
    statValues.forEach(stat => {
        const text = stat.textContent;
        if (text.includes('%')) {
            // 更新百分比
            const num = parseFloat(text);
            if (!isNaN(num)) {
                const change = (Math.random() - 0.5) * 2;
                const newNum = Math.max(0, Math.min(100, num + change));
                stat.textContent = newNum.toFixed(1) + '%';
            }
        } else if (text.includes('¥')) {
            // 更新金额
            const num = parseFloat(text.replace(/[¥,M]/g, ''));
            if (!isNaN(num)) {
                const change = (Math.random() - 0.5) * 0.2;
                const newNum = Math.max(0, num + change);
                stat.textContent = '¥' + newNum.toFixed(1) + 'M';
            }
        } else {
            // 更新数字
            const num = parseInt(text.replace(/,/g, ''));
            if (!isNaN(num)) {
                const change = Math.floor((Math.random() - 0.5) * 20);
                const newNum = Math.max(0, num + change);
                stat.textContent = newNum.toLocaleString();
            }
        }
    });
}

function filterStocks(filter) {
    // 更新激活状态
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
    
    // 重新加载股票数据
    loadPopularStocks(filter);
    
    showToast(`已切换到${getFilterName(filter)}股票`, 'info');
}

function getFilterName(filter) {
    const names = {
        'all': '全部',
        'tech': '科技',
        'finance': '金融',
        'energy': '能源'
    };
    return names[filter] || '全部';
}

function getTimeDifference(timestamp) {
    const now = new Date();
    const diff = Math.floor((now - timestamp) / (1000 * 60)); // minutes
    
    if (diff < 60) {
        return `${diff}分钟前`;
    } else if (diff < 1440) {
        return `${Math.floor(diff / 60)}小时前`;
    } else {
        return `${Math.floor(diff / 1440)}天前`;
    }
}

function viewPredictionDetail(predictionId) {
    showToast('预测详情功能开发中...', 'info');
}

function quickPredict(symbol) {
    document.getElementById('stock_symbol').value = symbol;
    document.getElementById('prediction-area').scrollIntoView({ behavior: 'smooth' });
    showToast(`已为 ${symbol} 预填写预测表单`, 'success');
}

function updateStats() {
    // 模拟统计数据更新
    const statValues = document.querySelectorAll('.stat-value');
    statValues.forEach(stat => {
        const text = stat.textContent;
        if (text.includes('%')) {
            // 更新百分比
            const num = parseFloat(text);
            if (!isNaN(num)) {
                const change = (Math.random() - 0.5) * 2;
                const newNum = Math.max(0, Math.min(100, num + change));
                stat.textContent = newNum.toFixed(1) + '%';
            }
        } else if (text.includes('¥')) {
            // 更新金额
            const num = parseFloat(text.replace(/[¥,M]/g, ''));
            if (!isNaN(num)) {
                const change = (Math.random() - 0.5) * 0.2;
                const newNum = Math.max(0, num + change);
                stat.textContent = '¥' + newNum.toFixed(1) + 'M';
            }
        } else {
            // 更新数字
            const num = parseInt(text.replace(/,/g, ''));
            if (!isNaN(num)) {
                const change = Math.floor((Math.random() - 0.5) * 20);
                const newNum = Math.max(0, num + change);
                stat.textContent = newNum.toLocaleString();
            }
        }
    });
}
</script>

<!-- CSS样式 -->
<style>
/* 股票搜索建议样式 */
.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    display: none;
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f5f5f5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s ease;
}

.suggestion-item:hover {
    background: linear-gradient(90deg, #f8f9fa, #e9ecef);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.stock-basic {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.stock-code {
    font-family: 'Courier New', monospace;
    font-weight: 700;
    color: #495057;
    font-size: 0.9rem;
}

.stock-name {
    color: #6c757d;
    font-size: 0.85rem;
}

.stock-price {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    text-align: right;
}

.price {
    font-weight: 600;
    color: #212529;
    font-size: 0.9rem;
}

.change {
    font-size: 0.75rem;
    font-weight: 500;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
    background: #f8f9fa;
}

/* 预测加载动画 */
.prediction-loading {
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    margin: 20px 0;
}

.loading-spinner {
    font-size: 3rem;
    margin-bottom: 20px;
    color: #ffd700;
}

.loading-spinner i {
    animation: spin 2s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.loading-progress {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 20px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffd700, #ff6b35);
    border-radius: 3px;
    transition: width 0.3s ease;
    width: 0%;
}

/* 预测结果样式 */
.prediction-result-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin: 20px 0;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
}

.stock-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.stock-name {
    margin: 0;
    color: #212529;
    font-size: 1.2rem;
}

.stock-code {
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #495057;
    font-size: 0.85rem;
}

.model-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-kronosbase {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
}

.badge-kronosmini {
    background: linear-gradient(45deg, #f093fb, #f5576c);
    color: white;
}

.badge-kronossmall {
    background: linear-gradient(45deg, #4facfe, #00f2fe);
    color: white;
}

.prediction-meta {
    text-align: right;
    color: #6c757d;
    font-size: 0.85rem;
}

.price-comparison {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.price-item {
    text-align: center;
    flex: 1;
}

.price-item label {
    display: block;
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.price-value {
    font-size: 1.4rem;
    font-weight: 700;
}

.price-arrow {
    font-size: 2rem;
    padding: 0 10px;
}

.prediction-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

.metric-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.metric-item label {
    display: block;
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.metric-value {
    font-size: 1.2rem;
    font-weight: 700;
}

.confidence-bar {
    margin-top: 8px;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
    transition: width 0.3s ease;
}

.prediction-analysis {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.prediction-analysis h6 {
    margin-bottom: 10px;
    color: #495057;
}

.analysis-points {
    margin: 0;
    padding-left: 20px;
}

.analysis-points li {
    margin-bottom: 5px;
    color: #6c757d;
}

.risk-warning {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    margin: 15px 0;
}

.risk-warning i {
    color: #f39c12;
}

.risk-warning small {
    color: #856404;
    margin: 0;
}

.result-actions {
    display: flex;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

/* Toast 提示样式 */
.toast-message {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    animation: slideInRight 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* 响应式设计 */
@media (max-width: 768px) {
    .price-comparison {
        flex-direction: column;
        gap: 15px;
    }
    
    .prediction-metrics {
        grid-template-columns: 1fr;
    }
    
    .result-actions {
        flex-wrap: wrap;
    }
    
    .stock-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}

/* 最近预测卡片样式 */
.recent-prediction {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.recent-prediction:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.prediction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.prediction-body {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.price-info {
    display: flex;
    gap: 20px;
}

.current-price, .predicted-price {
    text-align: center;
}

.current-price label, .predicted-price label {
    display: block;
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 2px;
}

.current-price span, .predicted-price span {
    font-weight: 600;
    font-size: 0.9rem;
}

.prediction-change {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
}

.prediction-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    color: #6c757d;
    border-top: 1px solid #f1f3f4;
    padding-top: 8px;
}

/* 股票卡片样式 */
.stock-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.stock-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #28a745;
}

.stock-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.stock-volume {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #6c757d;
    font-size: 0.85rem;
    margin-bottom: 12px;
}

.stock-actions {
    display: flex;
    gap: 8px;
    justify-content: space-between;
}

.stock-actions .btn {
    flex: 1;
    font-size: 0.8rem;
    padding: 4px 8px;
}

/* 筛选标签样式 */
.filter-tabs {
    display: flex;
    gap: 8px;
}

.filter-tab {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #6c757d;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-tab:hover {
    background: #e9ecef;
    border-color: #ced4da;
}

.filter-tab.active {
    background: #007bff;
    border-color: #007bff;
    color: white;
}

/* 网格布局 */
.predictions-grid {
    display: grid;
    gap: 16px;
}

.stocks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

@media (max-width: 768px) {
    .stocks-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-tabs {
        flex-wrap: wrap;
    }
    
    .stock-actions {
        flex-direction: column;
    }
}
</style>

{% endblock %}