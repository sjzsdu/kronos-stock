{% extends "layout.html" %}

{% block title %}ä»ªè¡¨ç›˜ - Kronos è‚¡ç¥¨é¢„æµ‹ç³»ç»Ÿ{% endblock %}

{% block header_title %}æ™ºèƒ½ä»ªè¡¨ç›˜{% endblock %}
{% block header_subtitle %}å…¨æ–¹ä½è‚¡ç¥¨é¢„æµ‹ä¸åˆ†æ{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- é‡å®šå‘åˆ°ç°ä»£ç‰ˆæœ¬çš„æç¤º -->
    <div class="alert alert-info">
        <h4><i class="fas fa-rocket"></i> æ–°ç‰ˆæœ¬å¯ç”¨</h4>
        <p>æˆ‘ä»¬æ¨èä½¿ç”¨æ–°çš„ç°ä»£åŒ–ç•Œé¢ï¼Œä½“éªŒæ›´å¥½çš„åŠŸèƒ½å’Œç•Œé¢è®¾è®¡ã€‚</p>
        <a href="/" class="btn btn-primary">
            <i class="fas fa-arrow-right"></i>
            å‰å¾€ç°ä»£ç‰ˆæœ¬
        </a>
    </div>
    
    <!-- Model Status Section -->
    <section class="card model-section">
        <h2>ğŸ¤– æ¨¡å‹çŠ¶æ€</h2>
        <div id="model-status" 
             hx-get="{{ url_for('views.model_status_component') }}"
             hx-trigger="load"
             hx-on:htmx:responseError="handleComponentError">
            <div class="loading">æ­£åœ¨æ£€æŸ¥æ¨¡å‹çŠ¶æ€...</div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="card quick-actions">
        <h2>ğŸš€ å¿«é€Ÿæ“ä½œ</h2>
        <div class="action-buttons">
            <button class="btn btn-primary" 
                    hx-get="{{ url_for('views.prediction_form_component') }}"
                    hx-target="#prediction-form"
                    hx-on:htmx:responseError="handleComponentError">
                æ–°å»ºé¢„æµ‹
            </button>
            <button class="btn btn-secondary"
                    onclick="window.open('/', '_blank')">
                ç°ä»£ç‰ˆæœ¬
            </button>
        </div>
    </section>

    <!-- Prediction Form Section -->
    <section class="card prediction-section">
        <h2>ğŸ“ˆ è‚¡ç¥¨é¢„æµ‹</h2>
        <div id="prediction-form"
             hx-get="{{ url_for('views.prediction_form_component') }}"
             hx-trigger="load"
             hx-on:htmx:responseError="handleComponentError">
            <div class="loading">åŠ è½½é¢„æµ‹è¡¨å•...</div>
        </div>
    </section>

    <!-- Results Section -->
    <section class="card results-section">
        <h2>ğŸ“Š é¢„æµ‹ç»“æœ</h2>
        <div id="prediction-results">
            <div class="placeholder">
                <p>ğŸ¯ è¯·å…ˆé€‰æ‹©è‚¡ç¥¨ä»£ç å¹¶ç‚¹å‡»é¢„æµ‹æŒ‰é’®</p>
                <small>æ”¯æŒä¸»æµAè‚¡ä»£ç ï¼š000001ã€600000ã€600519ç­‰</small>
            </div>
        </div>
    </section>

    <!-- Chart Section -->
    <section class="card chart-section">
        <h2>ğŸ“ˆ ä»·æ ¼èµ°åŠ¿å›¾</h2>
        <div id="chart-container">
            <div class="placeholder">
                <p>ğŸ“Š å›¾è¡¨å°†åœ¨é¢„æµ‹å®Œæˆåæ˜¾ç¤º</p>
                <small>åŒ…å«Kçº¿å›¾å’Œæˆäº¤é‡å›¾è¡¨</small>
            </div>
        </div>
    </section>

    <!-- System Info -->
    <section class="card system-info">
        <h2>â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">æ¶æ„ç‰ˆæœ¬:</span>
                <span class="info-value">HTMX ç°ä»£åŒ–</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ¨¡å‹æ”¯æŒ:</span>
                <span class="info-value">Kronos Mini/Small/Base</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ•°æ®æº:</span>
                <span class="info-value">å®æ—¶/æ¨¡æ‹Ÿæ•°æ®</span>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded with HTMX architecture');
    
    // Auto-refresh model status every 30 seconds
document.addEventListener('DOMContentLoaded', function() {
    setInterval(function() {
        // Use the global model status updater to avoid infinite loops
        if (window.modelStatusUpdater) {
            window.modelStatusUpdater.updateModelStatus();
        } else {
            htmx.ajax('GET', '{{ url_for("views.model_status_component") }}', {
                target: '#model-status'
            });
        }
    }, 30000);
});
});

// Enhanced HTMX event handlers for dashboard
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'prediction-results') {
        // Update chart after prediction
        const stockCode = document.querySelector('input[name="stock_code"]')?.value;
        if (stockCode) {
            htmx.ajax('GET', '/components/chart-container?stock_code=' + stockCode, {
                target: '#chart-container'
            });
        }
        
        // Show success notification
        if (event.detail.successful) {
            showNotification('é¢„æµ‹å®Œæˆï¼æŸ¥çœ‹ç»“æœå’Œå›¾è¡¨', 'success');
        }
    }
});

// Form validation
document.body.addEventListener('htmx:configRequest', function(event) {
    if (event.detail.path === '/components/prediction-result') {
        const form = event.detail.elt;
        const stockCode = form.querySelector('input[name="stock_code"]')?.value;
        
        if (!stockCode) {
            event.preventDefault();
            showNotification('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
            return false;
        }
        
        // Show loading notification
        showNotification('å¼€å§‹é¢„æµ‹ï¼Œè¯·ç¨å€™...', 'info');
    }
});

// Utility function for notifications (if not already defined)
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification`;
    notification.innerHTML = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Fade in
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    // Fade out and remove
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 4000);
}

function handleComponentError(event) {
    console.log('HTMX component error:', event);
    const target = event.detail.target;
    target.innerHTML = `
        <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle"></i> ç»„ä»¶åŠ è½½å¤±è´¥</h6>
            <p>è¯·å°è¯•åˆ·æ–°é¡µé¢ï¼Œæˆ–è€…ä½¿ç”¨ <a href="/" class="alert-link">ç°ä»£ç‰ˆæœ¬ç•Œé¢</a>ã€‚</p>
            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                <i class="fas fa-refresh"></i> åˆ·æ–°é¡µé¢
            </button>
        </div>
    `;
}
</script>
{% endblock %}