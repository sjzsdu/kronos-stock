{% extends "layouts/sidebar.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6 space-y-6">
    <!-- Filters and Search -->
    <div class="bg-white rounded-xl shadow-prediction p-6 transition-all duration-300 hover:shadow-lg">
        <div class="flex items-center gap-2 mb-4">
            <i class="fas fa-filter text-primary"></i>
            <h4 class="text-lg font-bold text-gray-800">筛选条件</h4>
        </div>
        
        <div class="flex flex-wrap gap-4 md:gap-6 items-end">
            <div class="flex flex-col min-w-[150px] md:flex-1">
                <label for="stockFilter" class="block text-sm font-medium text-gray-700 mb-2">股票代码</label>
                <input 
                    type="text" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                    id="stockFilter" 
                    placeholder="输入股票代码"
                >
            </div>
            
            <div class="flex flex-col min-w-[150px] md:flex-1">
                <label for="modelFilter" class="block text-sm font-medium text-gray-700 mb-2">模型类型</label>
                <select 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all bg-white"
                    id="modelFilter"
                >
                    <option value="">全部模型</option>
                    <option value="kronos-base">Kronos Base</option>
                    <option value="kronos-mini">Kronos Mini</option>
                    <option value="kronos-small">Kronos Small</option>
                </select>
            </div>
            
            <div class="flex flex-col min-w-[150px] md:flex-1">
                <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                <select 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all bg-white"
                    id="statusFilter"
                >
                    <option value="">全部状态</option>
                    <option value="completed">已完成</option>
                    <option value="failed">失败</option>
                    <option value="processing">处理中</option>
                </select>
            </div>
            
            <div class="flex flex-col min-w-[150px] md:flex-1">
                <label for="timeFilter" class="block text-sm font-medium text-gray-700 mb-2">时间范围</label>
                <select 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all bg-white"
                    id="timeFilter"
                >
                    <option value="">全部时间</option>
                    <option value="7">最近7天</option>
                    <option value="30">最近30天</option>
                    <option value="90">最近90天</option>
                </select>
            </div>
            
            <div class="flex gap-3 flex-shrink-0">
                <button 
                    class="bg-primary hover:bg-primary-dark text-white font-medium py-2.5 px-5 rounded-lg transition-all flex items-center gap-2 shadow-sm hover:shadow transform hover:-translate-y-0.5"
                    onclick="applyFilters()"
                >
                    <i class="fas fa-search"></i> 搜索
                </button>
                
                <button 
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2.5 px-5 rounded-lg transition-all flex items-center gap-2 shadow-sm"
                    onclick="resetFilters()"
                >
                    <i class="fas fa-redo"></i> 重置
                </button>
            </div>
        </div>
    </div>

    <!-- History Content -->
    <div class="bg-white rounded-xl shadow-prediction p-6 transition-all duration-300 hover:shadow-lg">
        <div class="flex items-center gap-2 mb-4">
            <i class="fas fa-history text-primary"></i>
            <h4 class="text-lg font-bold text-gray-800">预测记录</h4>
        </div>
        
        <div id="prediction-history" 
             hx-get="/api/predictions?page=1" 
             hx-trigger="load"
             hx-indicator="#history-loading"
             class="min-h-[300px]"
        >
            <div id="history-loading" class="htmx-indicator hidden">
                <div class="flex justify-center items-center py-10">
                    <i class="fas fa-spinner fa-spin text-primary mr-2"></i> 加载中...
                </div>
            </div>
            
            <div class="w-full h-60 bg-gradient-to-r from-gray-100 via-gray-200 to-gray-100 rounded-lg animate-pulse"></div>
        </div>
    </div>
</div>

<script>
function loadPredictionHistory(page) {
    htmx.ajax('GET', `/api/predictions?page=${page}`, '#prediction-history');
}

function viewPredictionDetail(predictionId) {
    // 获取预测详情并显示
    fetch(`/api/history/${predictionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPredictionModal(data.data);
            } else {
                alert(`无法获取预测详情: ${data.error}`);
            }
        })
        .catch(error => {
            alert(`获取预测详情失败: ${error.message}`);
        });
}

function showPredictionModal(record) {
    const modalContent = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closePredictionModal()">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">预测详情 #${record.id}</h3>
                    <button onclick="closePredictionModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">股票代码</label>
                        <p class="text-sm text-gray-900">${record.stock_code}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">模型类型</label>
                        <p class="text-sm text-gray-900">${record.model_type}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">预测天数</label>
                        <p class="text-sm text-gray-900">${record.prediction_days} 天</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">执行时间</label>
                        <p class="text-sm text-gray-900">${record.execution_time ? record.execution_time.toFixed(2) + 's' : '-'}</p>
                    </div>
                </div>
                
                ${record.prediction_data ? `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">预测结果</label>
                        <pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto">${JSON.stringify(record.prediction_data, null, 2)}</pre>
                    </div>
                ` : ''}
                
                ${record.error_message ? `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-red-700 mb-2">错误信息</label>
                        <p class="text-sm text-red-900 bg-red-50 p-3 rounded">${record.error_message}</p>
                    </div>
                ` : ''}
                
                <div class="flex justify-end">
                    <button onclick="closePredictionModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalContent);
}

function closePredictionModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

function applyFilters() {
    // 这里可以实现筛选逻辑
    const stockFilter = document.getElementById('stockFilter').value;
    const modelFilter = document.getElementById('modelFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const timeFilter = document.getElementById('timeFilter').value;
    
    // 构建查询参数
    const params = new URLSearchParams();
    if (stockFilter) params.append('stock_code', stockFilter);
    if (modelFilter) params.append('model_type', modelFilter);
    if (statusFilter) params.append('status', statusFilter);
    if (timeFilter) params.append('days', timeFilter);
    
    const url = `/api/predictions?${params.toString()}`;
    htmx.ajax('GET', url, '#prediction-history');
}

function resetFilters() {
    document.getElementById('stockFilter').value = '';
    document.getElementById('modelFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('timeFilter').value = '';
    
    // 重新加载所有历史记录
    loadPredictionHistory(1);
}
</script>
{% endblock %}