{% extends "layouts/dynamic_layout.html" %}

{% block content %}
<div class="page-content">
    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-header">
            <h4><i class="fas fa-filter"></i> 筛选条件</h4>
        </div>
        <div class="card-content">
            <div class="filter-row">
                <div class="filter-group">
                    <label>股票代码</label>
                    <input type="text" class="form-control" id="stockFilter" placeholder="输入股票代码">
                </div>
                <div class="filter-group">
                    <label>模型类型</label>
                    <select class="form-control" id="modelFilter">
                        <option value="">全部模型</option>
                        <option value="kronos-base">Kronos Base</option>
                        <option value="kronos-mini">Kronos Mini</option>
                        <option value="kronos-small">Kronos Small</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>状态</label>
                    <select class="form-control" id="statusFilter">
                        <option value="">全部状态</option>
                        <option value="active">进行中</option>
                        <option value="verified">已验证</option>
                        <option value="expired">已过期</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>时间范围</label>
                    <select class="form-control" id="timeFilter">
                        <option value="">全部时间</option>
                        <option value="7">最近7天</option>
                        <option value="30">最近30天</option>
                        <option value="90">最近90天</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search"></i> 搜索
                    </button>
                    <button class="btn btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Content -->
    <div class="card">
        <div class="card-header">
            <h4><i class="fas fa-history"></i> 预测记录</h4>
        </div>
        <div class="card-content">
            <div id="prediction-history" 
                 hx-get="/api/predictions?page=1" 
                 hx-trigger="load"
                 hx-indicator="#history-loading">
                <div id="history-loading" class="htmx-indicator">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <div class="loading-placeholder">
                    <div class="skeleton-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.prediction-history-container {
    width: 100%;
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.history-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.history-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.history-table-container {
    overflow-x: auto;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-primary);
    border-radius: 8px;
    overflow: hidden;
}

.history-table thead {
    background: var(--bg-secondary);
}

.history-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
}

.history-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
}

.history-table tbody tr:hover {
    background: var(--bg-secondary);
}

.stock-info .stock-symbol {
    font-weight: 600;
    color: var(--primary-color);
}

.stock-info .stock-name {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.confidence-display {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.confidence-bar {
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: var(--primary-color);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-verified {
    background: var(--success-light);
    color: var(--success-color);
}

.status-expired {
    background: var(--danger-light);
    color: var(--danger-color);
}

.status-active {
    background: var(--primary-light);
    color: var(--primary-color);
}

.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.pagination-info {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.no-history {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.no-history i {
    margin-bottom: 1rem;
    opacity: 0.5;
}

.no-history p {
    margin-bottom: 1.5rem;
    font-size: 1.1rem;
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.filter-group label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.filter-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.skeleton-table {
    width: 100%;
    height: 300px;
    background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-primary) 50%, var(--bg-secondary) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
    }
    
    .filter-group {
        min-width: 100%;
    }
    
    .history-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .history-table {
        font-size: 0.85rem;
    }
    
    .history-table th,
    .history-table td {
        padding: 0.5rem;
    }
}
</style>

<script>
function loadPredictionHistory(page) {
    htmx.ajax('GET', `/api/predictions?page=${page}`, '#prediction-history');
}

function viewPredictionDetail(predictionId) {
    // 这里可以实现查看预测详情的逻辑
    alert(`查看预测详情: ${predictionId}`);
}

function applyFilters() {
    // 这里可以实现筛选逻辑
    const stockFilter = document.getElementById('stockFilter').value;
    const modelFilter = document.getElementById('modelFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const timeFilter = document.getElementById('timeFilter').value;
    
    // 构建查询参数
    const params = new URLSearchParams();
    if (stockFilter) params.append('stock', stockFilter);
    if (modelFilter) params.append('model', modelFilter);
    if (statusFilter) params.append('status', statusFilter);
    if (timeFilter) params.append('days', timeFilter);
    
    const url = `/api/predictions?${params.toString()}`;
    htmx.ajax('GET', url, '#prediction-history');
}

function resetFilters() {
    document.getElementById('stockFilter').value = '';
    document.getElementById('modelFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('timeFilter').value = '';
    
    // 重新加载所有历史记录
    loadPredictionHistory(1);
}
</script>
{% endblock %}