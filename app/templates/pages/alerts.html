{% extends "layouts/dynamic_layout.html" %}

{% block page_title %}价格预警{% endblock %}
{% block page_subtitle %}设置和管理您的股票价格预警{% endblock %}

{% block content %}
<div class="page-content">
    <!-- Alerts Stats -->
    <div class="stats-grid mb-4">
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-bell"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalAlerts">0</div>
                <div class="stat-label">总预警数</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value text-success" id="activeAlerts">0</div>
                <div class="stat-label">已启用</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon danger">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value text-danger" id="triggeredAlerts">0</div>
                <div class="stat-label">已触发</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-history"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="todayAlerts">0</div>
                <div class="stat-label">今日预警</div>
            </div>
        </div>
    </div>

    <!-- Alerts Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h4><i class="fas fa-bolt"></i> 快速操作</h4>
        </div>
        <div class="card-content">
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="showCreateAlert()">
                    <i class="fas fa-plus"></i> 创建预警
                </button>
                <button class="btn btn-secondary" onclick="refreshAlerts()">
                    <i class="fas fa-sync"></i> 刷新数据
                </button>
                <button class="btn btn-success" onclick="enableAllAlerts()">
                    <i class="fas fa-toggle-on"></i> 启用全部
                </button>
                <button class="btn btn-warning" onclick="disableAllAlerts()">
                    <i class="fas fa-toggle-off"></i> 禁用全部
                </button>
            </div>
        </div>
    </div>

    <!-- Alerts Content -->
    <div class="card">
        <div class="card-header">
            <h4><i class="fas fa-list"></i> 预警列表</h4>
            <div class="card-actions">
                <div class="search-box">
                    <input type="text" class="form-control" placeholder="搜索股票..." id="alertsSearch">
                    <i class="fas fa-search"></i>
                </div>
                <select class="form-control" id="filterAlerts">
                    <option value="all">全部预警</option>
                    <option value="active">已启用</option>
                    <option value="inactive">已禁用</option>
                    <option value="triggered">已触发</option>
                </select>
            </div>
        </div>
        <div class="card-content">
            <div id="alerts-content" 
                 hx-get="/components/alerts" 
                 hx-trigger="load"
                 hx-indicator="#alerts-loading">
                <div id="alerts-loading" class="htmx-indicator">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <div class="loading-placeholder">
                    <div class="skeleton-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Alert Modal -->
<div class="modal" id="createAlertModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-bell"></i> 创建价格预警</h3>
            <button class="modal-close" onclick="closeModal('createAlertModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>股票代码</label>
                <input type="text" class="form-control" id="alertStockSymbol" placeholder="输入股票代码，如：000001">
                <div class="suggestions" id="alertStockSuggestions"></div>
            </div>
            <div class="form-group">
                <label>预警类型</label>
                <select class="form-control" id="alertType">
                    <option value="above">价格高于</option>
                    <option value="below">价格低于</option>
                    <option value="change_percent">涨跌幅</option>
                </select>
            </div>
            <div class="form-group">
                <label>目标价格/涨跌幅</label>
                <input type="number" class="form-control" id="targetValue" placeholder="输入目标价格或涨跌幅">
                <small class="form-help">涨跌幅请输入百分比，如：5 表示上涨5%</small>
            </div>
            <div class="form-group">
                <label>通知方式</label>
                <div class="notification-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="notifyEmail" checked>
                        <span>邮件通知</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="notifySms">
                        <span>短信通知</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="notifyApp" checked>
                        <span>应用内通知</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createAlertModal')">取消</button>
            <button class="btn btn-primary" onclick="createAlert()">创建</button>
        </div>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    background: var(--bg-primary);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
}

.stat-icon.primary {
    background: var(--primary-light);
    color: var(--primary-color);
}

.stat-icon.success {
    background: var(--success-light);
    color: var(--success-color);
}

.stat-icon.danger {
    background: var(--danger-light);
    color: var(--danger-color);
}

.stat-icon.warning {
    background: var(--warning-light);
    color: var(--warning-color);
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.quick-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .quick-actions {
        flex-direction: column;
    }
    
    .quick-actions .btn {
        width: 100%;
    }
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.card-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

@media (max-width: 768px) {
    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .card-actions {
        width: 100%;
        flex-direction: column;
    }
    
    .card-actions .search-box,
    .card-actions select {
        width: 100%;
    }
}

.search-box {
    position: relative;
}

.search-box .fas.fa-search {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.search-box input {
    padding-left: 2.5rem;
}

.alerts-table {
    width: 100%;
    border-collapse: collapse;
}

.alerts-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
}

.alerts-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.alerts-table tbody tr:hover {
    background: var(--bg-secondary);
}

.stock-info {
    display: flex;
    flex-direction: column;
}

.stock-symbol {
    font-weight: 600;
    color: var(--primary-color);
}

.stock-name {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.alert-type {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.alert-type.above {
    background: var(--success-light);
    color: var(--success-color);
}

.alert-type.below {
    background: var(--danger-light);
    color: var(--danger-color);
}

.alert-type.change_percent {
    background: var(--warning-light);
    color: var(--warning-color);
}

.alert-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.alert-status.active {
    background: var(--success-light);
    color: var(--success-color);
}

.alert-status.inactive {
    background: var(--text-light);
    color: var(--text-secondary);
}

.alert-status.triggered {
    background: var(--warning-light);
    color: var(--warning-color);
}

.alert-actions {
    display: flex;
    gap: 0.5rem;
}

.skeleton-table {
    width: 100%;
    height: 300px;
    background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-primary) 50%, var(--bg-secondary) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--bg-primary);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.notification-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.suggestions {
    position: absolute;
    width: 100%;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
}

.suggestion-item {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}

.suggestion-item:hover {
    background: var(--bg-secondary);
}

.suggestion-item:last-child {
    border-bottom: none;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
}
</style>

<script>
function showCreateAlert() {
    document.getElementById('createAlertModal').classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

function createAlert() {
    const symbol = document.getElementById('alertStockSymbol').value;
    const type = document.getElementById('alertType').value;
    const targetValue = document.getElementById('targetValue').value;
    
    if (!symbol || !targetValue) {
        alert('请填写完整信息');
        return;
    }
    
    // 这里应该调用API创建预警
    // 暂时使用localStorage模拟
    let alerts = JSON.parse(localStorage.getItem('priceAlerts') || '[]');
    
    const newAlert = {
        id: Date.now().toString(),
        symbol: symbol,
        type: type,
        targetValue: parseFloat(targetValue),
        isActive: true,
        createdAt: new Date().toISOString()
    };
    
    alerts.push(newAlert);
    localStorage.setItem('priceAlerts', JSON.stringify(alerts));
    
    closeModal('createAlertModal');
    refreshAlerts();
    showToast('预警创建成功', 'success');
}

function refreshAlerts() {
    htmx.ajax('GET', '/components/alerts', '#alerts-content');
}

function enableAllAlerts() {
    showToast('启用全部预警功能开发中...', 'info');
}

function disableAllAlerts() {
    showToast('禁用全部预警功能开发中...', 'info');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.classList.remove('show');
        }
    });
}

// Search functionality
document.getElementById('alertsSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    // 这里应该过滤显示的预警
    console.log('搜索:', searchTerm);
});

// Stock symbol search suggestions
document.getElementById('alertStockSymbol').addEventListener('input', function(e) {
    const query = e.target.value;
    if (query.length >= 2) {
        // 模拟API调用获取股票建议
        // 实际应该调用 /api/stocks/search?q=...
        const suggestions = document.getElementById('alertStockSuggestions');
        suggestions.innerHTML = `
            <div class="suggestion-item" onclick="selectAlertStock('000001', '平安银行')">000001 平安银行</div>
            <div class="suggestion-item" onclick="selectAlertStock('000002', '万科A')">000002 万科A</div>
            <div class="suggestion-item" onclick="selectAlertStock('600519', '贵州茅台')">600519 贵州茅台</div>
        `;
        suggestions.style.display = 'block';
    } else {
        document.getElementById('alertStockSuggestions').style.display = 'none';
    }
});

function selectAlertStock(symbol, name) {
    document.getElementById('alertStockSymbol').value = symbol;
    document.getElementById('alertStockSuggestions').style.display = 'none';
}

// Filter functionality
document.getElementById('filterAlerts').addEventListener('change', function(e) {
    const filter = e.target.value;
    // 这里应该过滤显示的预警
    console.log('筛选:', filter);
});
</script>
{% endblock %}