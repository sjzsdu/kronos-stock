{% extends "layouts/dashboard_layout.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- 重定向到现代版本的提示 -->
    <div class="alert alert-info">
        <h4><i class="fas fa-rocket"></i> 推荐使用新版本</h4>
        <p>体验全新的现代化界面和完善的功能。</p>
        <a href="/" class="btn btn-primary">前往现代版本</a>
    </div>
    
    <!-- Model Status Section -->
    <section class="card model-section">
        <h2>模型状态</h2>
        <div id="model-status" 
             hx-get="{{ url_for('views.model_status_component') }}"
             hx-trigger="load"
             hx-on:htmx:responseError="handleComponentError">
            <div class="loading">加载中...</div>
        </div>
    </section>

    <!-- Prediction Form Section -->
    <section class="card prediction-section">
        <h2>股票预测</h2>
        <div id="prediction-form"
             hx-get="{{ url_for('views.prediction_form_component') }}"
             hx-trigger="load"
             hx-on:htmx:responseError="handleComponentError">
            <div class="loading">加载中...</div>
        </div>
    </section>

    <!-- Results Section -->
    <section class="card results-section">
        <h2>预测结果</h2>
        <div id="prediction-results">
            <div class="placeholder">
                <p>请先选择股票代码并点击预测按钮</p>
            </div>
        </div>
    </section>

    <!-- Chart Section -->
    <section class="card chart-section">
        <h2>价格走势图</h2>
        <div id="chart-container">
            <div class="placeholder">
                <p>图表将在预测完成后显示</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// HTMX event handlers
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'prediction-results') {
        // Update chart after prediction
        const stockCode = document.querySelector('input[name="stock_code"]')?.value;
        if (stockCode) {
            htmx.ajax('GET', '/components/chart-container?stock_code=' + stockCode, {
                target: '#chart-container'
            });
        }
    }
});

// Form validation
document.body.addEventListener('htmx:configRequest', function(event) {
    if (event.detail.path === '/components/prediction-result') {
        const form = event.detail.elt;
        const stockCode = form.querySelector('input[name="stock_code"]')?.value;
        
        if (!stockCode) {
            event.preventDefault();
            alert('请输入股票代码');
            return false;
        }
    }
});

function handleComponentError(event) {
    console.log('HTMX component error:', event);
    const target = event.detail.target;
    target.innerHTML = `
        <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle"></i> 组件加载失败</h6>
            <p>请尝试刷新页面，或者使用 <a href="/" class="alert-link">现代版本界面</a>。</p>
            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                <i class="fas fa-refresh"></i> 刷新页面
            </button>
        </div>
    `;
}
</script>
{% endblock %}