{% extends "layout.html" %}

{% block page_title %}市场资讯{% endblock %}
{% block page_subtitle %}最新的股市新闻和市场动态{% endblock %}

{% block content %}
<div class="page-content">
    <!-- Market News Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h4><i class="fas fa-filter"></i> 筛选条件</h4>
        </div>
        <div class="card-content">
            <div class="news-filters">
                <div class="filter-group">
                    <label>资讯类型</label>
                    <div class="filter-chips">
                        <button class="chip active" onclick="filterNews('all')">全部</button>
                        <button class="chip" onclick="filterNews('market')">市场动态</button>
                        <button class="chip" onclick="filterNews('company')">公司新闻</button>
                        <button class="chip" onclick="filterNews('policy')">政策解读</button>
                        <button class="chip" onclick="filterNews('analysis')">分析报告</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label>时间范围</label>
                    <select class="form-control" id="timeFilter" onchange="changeTimeFilter(this.value)">
                        <option value="24h">24小时</option>
                        <option value="7d" selected>7天</option>
                        <option value="30d">30天</option>
                        <option value="90d">90天</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>关键词搜索</label>
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="搜索新闻..." id="newsSearch" oninput="searchNews(this.value)">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Overview -->
    <div class="stats-grid mb-4">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value text-success">+1.25%</div>
                <div class="stat-label">上证指数</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon danger">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value text-danger">-0.45%</div>
                <div class="stat-label">深证成指</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value text-success">+0.85%</div>
                <div class="stat-label">创业板指</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">24</div>
                <div class="stat-label">今日新闻</div>
            </div>
        </div>
    </div>

    <!-- News Content -->
    <div class="card">
        <div class="card-header">
            <h4><i class="fas fa-newspaper"></i> 最新资讯</h4>
            <div class="card-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshNews()">
                    <i class="fas fa-sync"></i> 刷新
                </button>
            </div>
        </div>
        <div class="card-content">
            <div id="news-content" 
                 hx-get="{{ url_for('views.market_news_component') }}" 
                 hx-trigger="load"
                 hx-indicator="#news-loading">
                <div id="news-loading" class="htmx-indicator">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载资讯...
                    </div>
                </div>
                <div class="loading-placeholder">
                    <div class="skeleton-news"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- News Detail Modal -->
<div class="modal" id="newsDetailModal">
    <div class="modal-content news-modal">
        <div class="modal-header">
            <h3 id="newsModalTitle">新闻详情</h3>
            <button class="modal-close" onclick="closeModal('newsDetailModal')">&times;</button>
        </div>
        <div class="modal-body" id="newsModalContent">
            <!-- News content will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('newsDetailModal')">关闭</button>
            <button class="btn btn-primary" onclick="shareNews()">
                <i class="fas fa-share"></i> 分享
            </button>
        </div>
    </div>
</div>

<style>
.news-filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.filter-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.chip {
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.chip:hover {
    background: var(--bg-primary);
    border-color: var(--primary-color);
}

.chip.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.search-box {
    position: relative;
}

.search-box .fas.fa-search {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.search-box input {
    padding-left: 2.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    background: var(--bg-primary);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
}

.stat-icon.primary {
    background: var(--primary-light);
    color: var(--primary-color);
}

.stat-icon.success {
    background: var(--success-light);
    color: var(--success-color);
}

.stat-icon.danger {
    background: var(--danger-light);
    color: var(--danger-color);
}

.stat-icon.warning {
    background: var(--warning-light);
    color: var(--warning-color);
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.news-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
}

.news-card {
    background: var(--bg-primary);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.news-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.news-image {
    width: 100%;
    height: 180px;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
}

.news-content {
    padding: 1.5rem;
}

.news-category {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-bottom: 0.75rem;
}

.news-category.market {
    background: var(--primary-light);
    color: var(--primary-color);
}

.news-category.company {
    background: var(--success-light);
    color: var(--success-color);
}

.news-category.policy {
    background: var(--warning-light);
    color: var(--warning-color);
}

.news-category.analysis {
    background: var(--danger-light);
    color: var(--danger-color);
}

.news-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
    line-height: 1.4;
}

.news-excerpt {
    color: var(--text-secondary);
    margin-bottom: 1rem;
    line-height: 1.5;
}

.news-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    color: var(--text-light);
}

.news-source {
    font-weight: 500;
}

.news-time {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.skeleton-news {
    width: 100%;
    height: 400px;
    background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-primary) 50%, var(--bg-secondary) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Modal Styles */
.modal.news-modal .modal-content {
    max-width: 800px;
    width: 90%;
}

.news-detail-content {
    line-height: 1.8;
}

.news-detail-content h1 {
    font-size: 1.8rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.news-detail-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
}

.news-detail-body {
    font-size: 1.1rem;
    color: var(--text-primary);
}

.news-detail-body p {
    margin-bottom: 1.5rem;
}

@media (max-width: 768px) {
    .news-filters {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .news-list {
        grid-template-columns: 1fr;
    }
    
    .modal.news-modal .modal-content {
        width: 95%;
        margin: 1rem;
    }
}
</style>

<script>
function filterNews(category) {
    // Update active chip
    document.querySelectorAll('.chip').forEach(chip => {
        chip.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filter news
    showToast(`筛选: ${category}`, 'info');
}

function changeTimeFilter(time) {
    showToast(`时间范围: ${time}`, 'info');
}

function searchNews(query) {
    if (query.length > 0) {
        showToast(`搜索: ${query}`, 'info');
    }
}

function refreshNews() {
    htmx.ajax('GET', '{{ url_for("views.market_news_component") }}', '#news-content');
    showToast('资讯已刷新', 'success');
}

function showNewsDetail(newsId) {
    // 模拟加载新闻详情
    const modal = document.getElementById('newsDetailModal');
    const modalTitle = document.getElementById('newsModalTitle');
    const modalContent = document.getElementById('newsModalContent');
    
    modalTitle.textContent = '市场迎来重大利好政策';
    modalContent.innerHTML = `
        <div class="news-detail-content">
            <h1>市场迎来重大利好政策</h1>
            <div class="news-detail-meta">
                <span><i class="fas fa-user"></i> 财经日报记者</span>
                <span><i class="fas fa-clock"></i> 2023-10-15 09:30</span>
                <span><i class="fas fa-tag"></i> 市场动态</span>
            </div>
            <div class="news-detail-body">
                <p>今日，国务院金融稳定发展委员会召开会议，研究部署进一步发挥资本市场功能，支持经济高质量发展。会议指出，要全面实行股票发行注册制，建立常态化退市机制，提高上市公司质量。</p>
                <p>会议强调，要加快建设规范、透明、开放、有活力、有韧性的资本市场，完善资本市场基础制度，把好市场入口和市场出口两道关，促进优胜劣汰。</p>
                <p>专家分析认为，这一系列政策将为资本市场注入新的活力，有助于提升市场效率和透明度，保护投资者合法权益，推动经济高质量发展。</p>
                <p>受此消息影响，今日开盘后A股市场普遍上涨，上证指数一度突破3200点关口，市场交投活跃，投资者信心明显增强。</p>
            </div>
        </div>
    `;
    
    modal.classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

function shareNews() {
    showToast('分享功能开发中...', 'info');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.classList.remove('show');
        }
    });
}
</script>
{% endblock %}