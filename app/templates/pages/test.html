{% extends "layouts/dynamic_layout.html" %}

{% block title %}系统测试 - Kronos{% endblock %}

{% block page_title %}系统功能测试{% endblock %}
{% block page_subtitle %}检查各项功能是否正常工作{% endblock %}

{% block content %}
<div class="test-dashboard">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Font Awesome 图标测试</h3>
                </div>
                <div class="card-content">
                    <div class="icon-test-grid">
                        <div class="icon-test-item">
                            <i class="fas fa-bell"></i>
                            <span>fa-bell</span>
                        </div>
                        <div class="icon-test-item">
                            <i class="fas fa-chart-line"></i>
                            <span>fa-chart-line</span>
                        </div>
                        <div class="icon-test-item">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>fa-tachometer-alt</span>
                        </div>
                        <div class="icon-test-item">
                            <i class="fas fa-users"></i>
                            <span>fa-users</span>
                        </div>
                        <div class="icon-test-item">
                            <i class="fas fa-crown"></i>
                            <span>fa-crown</span>
                        </div>
                        <div class="icon-test-item">
                            <i class="fas fa-cog"></i>
                            <span>fa-cog</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>API 接口测试</h3>
                </div>
                <div class="card-content">
                    <div class="test-buttons">
                        <button class="btn btn-primary" onclick="testNotificationAPI()">
                            <i class="fas fa-bell"></i>
                            测试通知 API
                        </button>
                        <button class="btn btn-secondary" onclick="testMarketNewsAPI()">
                            <i class="fas fa-newspaper"></i>
                            测试市场新闻 API
                        </button>
                        <button class="btn btn-success" onclick="testLayoutManager()">
                            <i class="fas fa-cog"></i>
                            测试 LayoutManager
                        </button>
                    </div>
                    
                    <div id="test-results" class="test-results">
                        <h4>测试结果：</h4>
                        <div id="test-output"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>市场新闻组件测试</h3>
                </div>
                <div class="card-content">
                    <div id="news-test" 
                         hx-get="{{ url_for('views.market_news_component') }}" 
                         hx-trigger="load"
                         hx-indicator="#news-loading">
                        <div id="news-loading" class="htmx-indicator">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin"></i> 加载中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.test-dashboard .row {
    margin-bottom: 2rem;
}

.icon-test-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.icon-test-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    text-align: center;
}

.icon-test-item i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #3b82f6;
}

.icon-test-item span {
    font-size: 0.875rem;
    color: #6b7280;
}

.test-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
}

.test-results {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    min-height: 200px;
}

#test-output {
    font-family: monospace;
    font-size: 0.875rem;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.loading-spinner {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
}
</style>

<script>
function logTest(message) {
    const output = document.getElementById('test-output');
    const timestamp = new Date().toLocaleTimeString();
    output.textContent += `[${timestamp}] ${message}\n`;
    output.scrollTop = output.scrollHeight;
}

function testNotificationAPI() {
    logTest('开始测试通知 API...');
    
    fetch('/api/notifications/check')
        .then(response => {
            logTest(`响应状态: ${response.status}`);
            return response.json();
        })
        .then(data => {
            logTest(`通知 API 响应: ${JSON.stringify(data, null, 2)}`);
            if (data.success) {
                logTest('✅ 通知 API 测试成功');
            } else {
                logTest('❌ 通知 API 测试失败');
            }
        })
        .catch(error => {
            logTest(`❌ 通知 API 测试出错: ${error.message}`);
        });
}

function testMarketNewsAPI() {
    logTest('开始测试市场新闻组件...');
    
    htmx.ajax('GET', '{{ url_for("views.market_news_component") }}', {
        target: '#news-test',
        swap: 'innerHTML'
    }).then(() => {
        logTest('✅ 市场新闻组件加载成功');
    }).catch(error => {
        logTest(`❌ 市场新闻组件加载失败: ${error.message}`);
    });
}

function testLayoutManager() {
    logTest('开始测试 LayoutManager...');
    
    if (window.layoutManager) {
        logTest('✅ LayoutManager 实例存在');
        
        // 测试通知检查功能
        if (typeof window.layoutManager.checkNotifications === 'function') {
            logTest('✅ checkNotifications 方法存在');
            window.layoutManager.checkNotifications();
            logTest('✅ 已调用 checkNotifications 方法');
        } else {
            logTest('❌ checkNotifications 方法不存在');
        }
        
        // 测试通知图标更新
        if (typeof window.layoutManager.updateNotificationIcon === 'function') {
            logTest('✅ updateNotificationIcon 方法存在');
            window.layoutManager.updateNotificationIcon(5);
            logTest('✅ 已调用 updateNotificationIcon 方法（设置为 5）');
        } else {
            logTest('❌ updateNotificationIcon 方法不存在');
        }
        
    } else {
        logTest('❌ LayoutManager 实例不存在');
    }
}

// 页面加载时自动运行一些测试
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        logTest('页面加载完成，开始自动测试...');
        
        // 检查 Font Awesome
        const testIcon = document.querySelector('.icon-test-item i');
        if (testIcon) {
            const computed = window.getComputedStyle(testIcon, '::before');
            const fontFamily = computed.getPropertyValue('font-family');
            if (fontFamily.includes('Font Awesome')) {
                logTest('✅ Font Awesome 图标正常加载');
            } else {
                logTest('⚠️ Font Awesome 图标使用回退方案');
            }
        }
        
        // 检查 HTMX
        if (typeof htmx !== 'undefined') {
            logTest('✅ HTMX 已加载');
        } else {
            logTest('❌ HTMX 未加载');
        }
        
        // 检查 LayoutManager
        if (window.layoutManager) {
            logTest('✅ LayoutManager 已初始化');
        } else {
            logTest('❌ LayoutManager 未初始化');
        }
        
    }, 1000);
});
</script>
{% endblock %}