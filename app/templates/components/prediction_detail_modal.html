<!-- Enhanced Prediction Detail Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closePredictionModal()">
    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-primary to-primary-dark text-white">
            <div class="flex items-center gap-4">
                <div class="p-2 bg-white bg-opacity-20 rounded-lg">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold">预测详情分析</h3>
                    <p class="text-sm opacity-90">预测记录 #{{ record.id }} - {{ record.stock_code }}</p>
                </div>
            </div>
            <button onclick="closePredictionModal()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="overflow-y-auto max-h-[calc(90vh-80px)]">
            <!-- Stock Info Section -->
            <div class="p-6 border-b border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Stock Basic Info Card -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-building text-blue-600"></i>
                            股票信息
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">股票代码:</span>
                                <span class="font-medium">{{ record.stock_code }}</span>
                            </div>
                            {% if record.stock_basic_info and not record.stock_basic_info.error %}
                            <div class="flex justify-between">
                                <span class="text-gray-600">股票名称:</span>
                                <span class="font-medium">{{ record.stock_basic_info.name or '暂无' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">行业:</span>
                                <span class="font-medium">{{ record.stock_basic_info.industry or '暂无' }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Current Price Card -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-dollar-sign text-green-600"></i>
                            当前价格
                        </h4>
                        {% if record.current_stock_info and not record.current_stock_info.error %}
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">现价:</span>
                                <span class="font-bold text-lg">¥{{ "%.2f"|format(record.current_stock_info.current_price) }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">涨跌:</span>
                                <span class="font-medium {% if record.current_stock_info.price_change >= 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                    {% if record.current_stock_info.price_change >= 0 %}+{% endif %}{{ "%.2f"|format(record.current_stock_info.price_change) }}
                                    ({{ "%.2f"|format(record.current_stock_info.price_change_percent) }}%)
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">成交量:</span>
                                <span class="font-medium">{{ "{:,}".format(record.current_stock_info.volume) }}</span>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-red-500 text-sm">{{ record.current_stock_info.error or '获取数据失败' }}</p>
                        {% endif %}
                    </div>

                    <!-- Prediction Info Card -->
                    <div class="bg-gradient-to-br from-purple-50 to-violet-100 rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-robot text-purple-600"></i>
                            预测信息
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">模型:</span>
                                <span class="font-medium">{{ record.model_type }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">预测天数:</span>
                                <span class="font-medium">{{ record.prediction_days }} 天</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">执行时间:</span>
                                <span class="font-medium">{{ "%.2f"|format(record.execution_time) }}s</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">状态:</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {% if record.status == 'completed' %}bg-green-100 text-green-800
                                    {% elif record.status == 'failed' %}bg-red-100 text-red-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ record.status }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prediction Results Section -->
            {% if record.status == 'completed' and record.prediction_data %}
            <div class="p-6 border-b border-gray-100">
                <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-area text-primary"></i>
                    预测结果与分析
                </h4>
                
                <!-- Chart Container -->
                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <div id="prediction-chart" style="height: 400px;" class="w-full">
                        <!-- Chart will be rendered here by JavaScript -->
                        <div class="flex items-center justify-center h-full" id="chart-placeholder">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p class="text-gray-500">正在加载预测图表...</p>
                                <p class="text-gray-400 text-sm mt-2">如果图表未能加载，请检查预测数据</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prediction Data Display -->
                <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
                    <h5 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-table text-blue-600"></i>
                        预测数据
                    </h5>
                    {% if record.prediction_data and record.prediction_data.prediction_results %}
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">预测价格</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">变化</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {% for result in record.prediction_data.prediction_results[:7] %}
                                    <tr>
                                        <td class="px-3 py-2 text-sm text-gray-900">{{ result.date }}</td>
                                        <td class="px-3 py-2 text-sm font-medium text-gray-900">¥{{ "%.2f"|format(result.close) }}</td>
                                        <td class="px-3 py-2 text-sm">
                                            {% if loop.index > 1 %}
                                                {% set prev_result = record.prediction_data.prediction_results[loop.index0-1] %}
                                                {% set change = result.close - prev_result.close %}
                                                {% set change_percent = (change / prev_result.close * 100) %}
                                                <span class="{% if change >= 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                                    {% if change >= 0 %}+{% endif %}{{ "%.2f"|format(change) }} ({{ "%.2f"|format(change_percent) }}%)
                                                </span>
                                            {% else %}
                                                <span class="text-gray-400">基准</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-gray-500 text-center py-4">暂无预测数据</p>
                    {% endif %}
                </div>

                <!-- Accuracy Analysis -->
                {% if record.accuracy_analysis %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    {% if record.accuracy_analysis.status == 'completed' %}
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h5 class="font-semibold text-blue-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-bullseye"></i>
                            预测准确率
                        </h5>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">价格误差 (MAPE):</span>
                                <span class="font-bold text-blue-700">{{ "%.2f"|format(record.accuracy_analysis.mape) }}%</span>
                            </div>
                            {% if record.accuracy_analysis.directional_accuracy %}
                            <div class="flex justify-between">
                                <span class="text-gray-600">方向准确率:</span>
                                <span class="font-bold text-blue-700">{{ "%.1f"|format(record.accuracy_analysis.directional_accuracy) }}%</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% elif record.accuracy_analysis.status == 'insufficient_data' %}
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h5 class="font-semibold text-yellow-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-clock"></i>
                            等待验证
                        </h5>
                        <p class="text-yellow-700 text-sm">{{ record.accuracy_analysis.message }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Prediction Summary -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h5 class="font-semibold text-green-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-chart-line"></i>
                            预测摘要
                        </h5>
                        {% if record.prediction_data and record.prediction_data.prediction_results %}
                            {% set first_result = record.prediction_data.prediction_results[0] %}
                            {% set last_result = record.prediction_data.prediction_results[-1] %}
                            {% set price_change = last_result.close - first_result.close %}
                            {% set price_change_percent = (price_change / first_result.close * 100) %}
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">预测趋势:</span>
                                    <span class="font-bold {% if price_change >= 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                        {% if price_change >= 0 %}上涨{% else %}下跌{% endif %}
                                        {{ "%.2f"|format(price_change_percent|abs) }}%
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">起始价位:</span>
                                    <span class="font-bold text-gray-700">¥{{ "%.2f"|format(first_result.close) }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">目标价位:</span>
                                    <span class="font-bold text-green-700">¥{{ "%.2f"|format(last_result.close) }}</span>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-gray-500 text-sm">暂无预测数据</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- Show when prediction is not completed or no data -->
            <div class="p-6 border-b border-gray-100">
                <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-gray-500"></i>
                    预测状态
                </h4>
                <div class="bg-gray-50 rounded-xl p-6 text-center">
                    {% if record.status != 'completed' %}
                        <i class="fas fa-clock text-3xl text-gray-400 mb-4"></i>
                        <h5 class="text-lg font-medium text-gray-700 mb-2">预测未完成</h5>
                        <p class="text-gray-500">当前状态: {{ record.status }}</p>
                    {% else %}
                        <i class="fas fa-exclamation-triangle text-3xl text-yellow-400 mb-4"></i>
                        <h5 class="text-lg font-medium text-gray-700 mb-2">暂无预测数据</h5>
                        <p class="text-gray-500">预测已完成但数据不可用</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Error Information -->
            {% if record.error_message %}
            <div class="p-6 border-b border-gray-100">
                <h4 class="text-xl font-semibold text-red-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    错误信息
                </h4>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800">{{ record.error_message }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="p-6 bg-gray-50 flex flex-wrap gap-3 justify-end">
                <button onclick="sharePrediction({{ record.id }})" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2">
                    <i class="fas fa-share-alt"></i> 分享
                </button>
                
                <button onclick="exportPrediction({{ record.id }})" 
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">
                    <i class="fas fa-download"></i> 导出
                </button>
                
                <button onclick="createSimilarPrediction('{{ record.stock_code }}', '{{ record.model_type }}', {{ record.prediction_days }})" 
                        class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors flex items-center gap-2">
                    <i class="fas fa-redo"></i> 重新预测
                </button>
                
                <button onclick="closePredictionModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize chart immediately when script is loaded
(function() {
    // Add a small delay to ensure DOM is ready
    setTimeout(function() {
        if (typeof Plotly !== 'undefined' && document.getElementById('prediction-chart')) {
            loadPredictionChart({{ record.id }});
        } else {
            console.log('Plotly not available or chart container not found');
            // Try again after a longer delay
            setTimeout(function() {
                if (typeof Plotly !== 'undefined' && document.getElementById('prediction-chart')) {
                    loadPredictionChart({{ record.id }});
                } else {
                    console.error('Failed to initialize chart: Plotly or container still not available');
                }
            }, 1000);
        }
    }, 100);
})();

// Also make the function globally available for external calls
window.initPredictionModalChart = function() {
    if (typeof Plotly !== 'undefined' && document.getElementById('prediction-chart')) {
        loadPredictionChart({{ record.id }});
    }
};

function loadPredictionChart(recordId) {
    console.log('开始加载预测图表，记录ID:', recordId);
    
    // Show loading state
    const chartContainer = document.getElementById('prediction-chart');
    if (!chartContainer) {
        console.error('找不到图表容器元素 #prediction-chart');
        return;
    }
    
    console.log('找到图表容器，显示加载状态');
    chartContainer.innerHTML = `
        <div class="flex items-center justify-center h-64">
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">正在加载图表数据...</p>
            </div>
        </div>
    `;
    
    // Fetch and render chart data directly
    const apiUrl = `/api/predictions/${recordId}/chart-data`;
    console.log('请求图表数据API:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('API响应状态:', response.status);
            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('收到图表数据:', data);
            if (data.error) {
                console.error('API返回错误:', data.error);
                showChartError(data.error);
                return;
            }
            console.log('开始渲染图表');
            renderPredictionChart(data);
        })
        .catch(error => {
            console.error('获取图表数据失败:', error);
            showChartError('获取图表数据失败: ' + error.message);
        });
}

// Chart rendering function
function renderPredictionChart(chartData) {
    console.log('开始渲染图表，数据:', chartData);
    
    const chartContainer = document.getElementById('prediction-chart');
    if (!chartContainer) {
        console.error('找不到图表容器元素');
        return;
    }

    // Check if Plotly is available
    if (typeof Plotly === 'undefined') {
        console.error('Plotly库未加载');
        showChartError('图表库未加载，请刷新页面重试');
        return;
    }

    const traces = [];

    // Historical price trace
    if (chartData.historical_data && chartData.historical_data.length > 0) {
        console.log(`添加历史数据追踪，${chartData.historical_data.length}个数据点`);
        traces.push({
            x: chartData.historical_data.map(d => d.date),
            y: chartData.historical_data.map(d => d.price),
            type: 'scatter',
            mode: 'lines',
            name: '历史价格',
            line: { color: '#3B82F6', width: 2 },
            hovertemplate: '日期: %{x}<br>价格: ¥%{y:.2f}<extra></extra>'
        });
    }

    // Prediction trace
    if (chartData.prediction_data && chartData.prediction_data.length > 0) {
        console.log(`添加预测数据追踪，${chartData.prediction_data.length}个数据点`);
        traces.push({
            x: chartData.prediction_data.map(d => d.date),
            y: chartData.prediction_data.map(d => d.predicted_price),
            type: 'scatter',
            mode: 'lines+markers',
            name: '预测价格',
            line: { color: '#EF4444', width: 2, dash: 'dash' },
            marker: { size: 6, color: '#EF4444' },
            hovertemplate: '日期: %{x}<br>预测价格: ¥%{y:.2f}<extra></extra>'
        });
    } else {
        console.warn('没有预测数据可显示');
    }

    // Actual price trace (for comparison if available)
    if (chartData.actual_data && chartData.actual_data.length > 0) {
        console.log(`添加实际数据追踪，${chartData.actual_data.length}个数据点`);
        traces.push({
            x: chartData.actual_data.map(d => d.date),
            y: chartData.actual_data.map(d => d.actual_price),
            type: 'scatter',
            mode: 'lines+markers',
            name: '实际价格',
            line: { color: '#10B981', width: 2 },
            marker: { size: 6, color: '#10B981' },
            hovertemplate: '日期: %{x}<br>实际价格: ¥%{y:.2f}<extra></extra>'
        });
    }

    if (traces.length === 0) {
        console.error('没有可显示的数据追踪');
        showChartError('没有可显示的数据');
        return;
    }

    console.log(`准备渲染 ${traces.length} 个数据追踪`);

    const layout = {
        title: {
            text: `${chartData.stock_code} 股价预测分析`,
            font: { size: 18, color: '#374151' }
        },
        xaxis: {
            title: '日期',
            type: 'date',
            gridcolor: '#E5E7EB',
            showgrid: true
        },
        yaxis: {
            title: '价格 (¥)',
            gridcolor: '#E5E7EB',
            showgrid: true,
            tickformat: '.2f'
        },
        legend: {
            x: 0,
            y: 1,
            bgcolor: 'rgba(255, 255, 255, 0.8)',
            bordercolor: '#E5E7EB',
            borderwidth: 1
        },
        hovermode: 'x unified',
        margin: { l: 60, r: 20, t: 60, b: 60 },
        plot_bgcolor: '#FAFAFA',
        paper_bgcolor: '#FFFFFF'
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
        displaylogo: false,
        toImageButtonOptions: {
            format: 'png',
            filename: `prediction_${chartData.stock_code}_${new Date().getTime()}`,
            height: 500,
            width: 800,
            scale: 1
        }
    };

    try {
        console.log('调用Plotly.newPlot渲染图表');
        Plotly.newPlot(chartContainer, traces, layout, config);
        console.log('图表渲染完成');
    } catch (error) {
        console.error('Plotly渲染失败:', error);
        showChartError('图表渲染失败: ' + error.message);
    }
}

// Show chart error
function showChartError(errorMessage) {
    const chartContainer = document.getElementById('prediction-chart');
    if (chartContainer) {
        chartContainer.innerHTML = `
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <p class="text-gray-600">${errorMessage}</p>
                </div>
            </div>
        `;
    }
}
</script>