{% if success %}
<!-- Enhanced Prediction Result Component -->
<div class="prediction-result-container">
    <!-- Summary Card -->
    <div class="prediction-summary-card">
        <div class="summary-header">
            <h4>
                <i class="fas fa-chart-line"></i>
                股票代码: {{ data.stock_code }}
            </h4>
            <div class="trend-badge trend-{{ data.prediction_summary.trend }}">
                <i class="fas fa-{{ 'arrow-up' if data.prediction_summary.trend == 'bullish' else 'arrow-down' }}"></i>
                {{ '看涨' if data.prediction_summary.trend == 'bullish' else '看跌' }}
            </div>
        </div>
        
        <div class="summary-metrics">
            <div class="metric">
                <span class="metric-label">当前价格</span>
                <span class="metric-value">¥{{ "%.2f"|format(data.prediction_summary.current_price) }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">预测价格</span>
                <span class="metric-value target-price">¥{{ "%.2f"|format(data.prediction_summary.target_price) }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">预期涨幅</span>
                <span class="metric-value change-pct {{ 'positive' if data.prediction_summary.total_change_pct > 0 else 'negative' }}">
                    {{ "%.2f"|format(data.prediction_summary.total_change_pct) }}%
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">预测周期</span>
                <span class="metric-value">{{ data.prediction_summary.prediction_period }}</span>
            </div>
        </div>
    </div>

    <!-- Chart Container -->
    <div class="prediction-chart-container">
        <h5><i class="fas fa-chart-area"></i> 价格走势预测</h5>
        <div class="chart-wrapper">
            <canvas id="predictionChart" width="800" height="300"></canvas>
        </div>
    </div>

    <!-- Prediction Data Table -->
    <div class="prediction-data-table">
        <h5><i class="fas fa-table"></i> 预测数据详情</h5>
        <div class="table-container">
            <table class="prediction-table">
                <thead>
                    <tr>
                        <th class="date-column">日期</th>
                        <th class="price-column">最高价</th>
                        <th class="price-column">最低价</th>
                        <th class="price-column">收盘价</th>
                        <th class="change-column">涨跌幅</th>
                        <th class="volume-column">成交量</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.prediction_results %}
                    <tr class="prediction-row">
                        <td class="date-cell">
                            <div class="date-info">
                                <span class="date">{{ item.date }}</span>
                                <span class="weekday">{{ item.weekday }}</span>
                            </div>
                        </td>
                        <td class="price-cell price-high">¥{{ "%.2f"|format(item.high) }}</td>
                        <td class="price-cell price-low">¥{{ "%.2f"|format(item.low) }}</td>
                        <td class="price-cell price-close">¥{{ "%.2f"|format(item.close) }}</td>
                        <td class="change-cell">
                            <span class="change-value {{ 'positive' if item.change_pct > 0 else 'negative' }}">
                                {{ "%.2f"|format(item.change_pct) }}%
                            </span>
                        </td>
                        <td class="volume-cell">{{ "{:,}".format(item.volume|int) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analysis Notes -->
    <div class="prediction-notes">
        <h5><i class="fas fa-info-circle"></i> 预测说明</h5>
        <div class="notes-content">
            <div class="note-item">
                <i class="fas fa-clock"></i>
                <span>预测基于最近{{ data.prediction_summary.actual_lookback }}个交易日的历史数据</span>
            </div>
            <div class="note-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span>此预测仅供参考，投资有风险，请谨慎决策</span>
            </div>
            <div class="note-item">
                <i class="fas fa-save"></i>
                <span>预测结果已保存至: {{ data.saved_file }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Data for Chart -->
<script type="application/json" id="chartData">
{
    "historical": {{ data.historical_data|tojson }},
    "prediction": {{ data.prediction_results|tojson }},
    "currentPrice": {{ data.prediction_summary.current_price }}
}
</script>

<script>
// Chart.js visualization with Chinese financial color conventions
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('predictionChart');
    if (ctx && typeof Chart !== 'undefined') {
        // Get data from JSON script tag
        const chartDataElement = document.getElementById('chartData');
        if (!chartDataElement) {
            console.error('Chart data not found');
            return;
        }
        
        try {
            const chartData = JSON.parse(chartDataElement.textContent);
            
            const historicalData = chartData.historical || [];
            const predictionData = chartData.prediction || [];
            const currentPrice = chartData.currentPrice || 0;
            
            // Prepare chart data
            const allDates = [
                ...historicalData.slice(-10).map(item => item.date),
                ...predictionData.map(item => item.date)
            ];
            
            const historicalPrices = [
                ...historicalData.slice(-10).map(item => item.close),
                ...Array(predictionData.length).fill(null)
            ];
            
            const predictionPrices = [
                ...Array(Math.max(0, allDates.length - predictionData.length - 1)).fill(null),
                currentPrice,
                ...predictionData.map(item => item.close)
            ];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: [{
                        label: '历史价格',
                        data: historicalPrices,
                        borderColor: 'var(--chart-historical-color)',
                        backgroundColor: 'var(--chart-historical-bg)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }, {
                        label: '预测价格',
                        data: predictionPrices,
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'var(--chart-prediction-bg)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointBackgroundColor: 'var(--primary-color)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '价格 (¥)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: 'var(--text-secondary)'
                            },
                            grid: {
                                color: 'var(--border-color)'
                            },
                            ticks: {
                                color: 'var(--text-secondary)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: 'var(--text-secondary)'
                            },
                            grid: {
                                color: 'var(--border-color)'
                            },
                            ticks: {
                                color: 'var(--text-secondary)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                color: 'var(--text-primary)'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ¥' + parseFloat(context.parsed.y).toFixed(2);
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error initializing chart:', error);
            // Show fallback message
            ctx.parentElement.innerHTML = '<div class="chart-error">图表加载失败，请刷新页面重试</div>';
        }
    } else {
        console.error('Chart.js not loaded or canvas element not found');
        if (ctx) {
            ctx.parentElement.innerHTML = '<div class="chart-error">图表库未加载，请检查网络连接</div>';
        }
    }
});
</script>
{% else %}
<!-- Error Display -->
<div class="prediction-error">
    <div class="error-icon">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    <div class="error-message">
        <h4>预测失败</h4>
        <p>{{ error }}</p>
    </div>
</div>
{% endif %}
